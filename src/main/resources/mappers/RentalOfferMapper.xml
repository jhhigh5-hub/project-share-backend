<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.sharebackend.mapper.RentalOfferMapper">

    <!-- ============================================== -->
    <!-- 1. ë§¤ë¬¼ ë“±ë¡ ë° ê´€ë ¨ ì¿¼ë¦¬ -->
    <!-- ============================================== -->
    <insert id="insertRentalOffer" parameterType="com.example.sharebackend.domain.RentalOffer" useGeneratedKeys="true" keyProperty="idx">
        insert into rental_offer (account_id, car_idx, rental_price, description)
        values (#{accountId}, #{carIdx}, #{rentalPrice}, #{description})
    </insert>

    <insert id="insertCarImg" parameterType="com.example.sharebackend.domain.CarImg" useGeneratedKeys="true"
            keyProperty="idx">
        insert into car_img (rental_offer_idx, img)
        values (#{rentalOfferIdx}, #{img})
    </insert>

    <!-- íŠ¹ì • ë§¤ë¬¼ì˜ ì´ë¯¸ì§€ ì¡°íšŒ (ë§¤ë¬¼ ë“±ë¡ ì„±ê³µ ì‘ë‹µ, ìƒì„¸ íŽ˜ì´ì§€ ë“±ì—ì„œ ì‚¬ìš©) -->
    <select id="findCarImgs" parameterType="int" resultType="com.example.sharebackend.domain.CarImg">
        SELECT idx, rental_offer_idx, img
        FROM car_img
        WHERE rental_offer_idx = #{rentalOfferIdx}
        ORDER BY idx ASC
    </select>

    <!-- ============================================== -->
    <!-- 2. ë‹¨ì¼ ë§¤ë¬¼ ì¡°íšŒ / ì¹´ìš´íŠ¸ ì¿¼ë¦¬ (í•„ìš” ì‹œ) -->
    <!-- ============================================== -->
    <!-- ì°Œë¦¬ XMLì— ì´ë¯¸ ìžˆì—ˆë˜ ì¿¼ë¦¬ -->
    <select id="selectByRentalPrice" resultType="int" parameterType="int">
        select rental_price from rental_offer where idx=#{idx}
    </select>

    <!-- ì „ì²´ RentalOffer ê°œìˆ˜ ì¡°íšŒ (ì¹´ìš´íŠ¸ìš©) -->
    <select id="countAllRentalOffer" resultType="int">
        select count(*) from rental_offer
    </select>

    <!-- ============================================== -->
    <!-- 3. RentalOfferResponse DTO ë§¤í•‘ì„ ìœ„í•œ resultMap ì •ì˜ (ë”± í•œ ë²ˆë§Œ! â—ï¸) -->
    <!-- ============================================== -->
    <resultMap id="rentalOfferResponseMap" type="com.example.sharebackend.response.RentalOfferResponse">
        <!-- RentalOffer ê¸°ë³¸ í•„ë“œ ë§¤í•‘ -->
        <id property="idx" column="ro_idx"/> <!-- rental_offerì˜ PKë¥¼ ro_idxë¡œ ë³„ì¹­ -->
        <result property="accountId" column="account_id"/>
        <result property="carIdx" column="car_idx"/>
        <result property="rentalPrice" column="rental_price"/>
        <result property="description" column="description"/>
        <!-- ... ê¸°íƒ€ RentalOfferì˜ í•„ë“œê°€ ìžˆë‹¤ë©´ ì—¬ê¸°ì— ì¶”ê°€ ... -->

        <!-- carImages ë¦¬ìŠ¤íŠ¸ ë§¤í•‘ (collection íƒœê·¸ ì‚¬ìš©) -->
        <collection property="carImages" javaType="com.example.sharebackend.domain.CarImg">
            <id property="idx" column="ci_idx"/> <!-- car_imgì˜ PKë¥¼ ci_idxë¡œ ë³„ì¹­ -->
            <result property="rentalOfferIdx" column="ci_rental_offer_idx"/>
            <result property="img" column="img_url"/> <!-- car_imgì˜ img ì»¬ëŸ¼ì„ img_urlë¡œ ë³„ì¹­ -->
        </collection>
    </resultMap>

    <!-- ============================================== -->
    <!-- 4. ëª©ë¡ ì¡°íšŒ ì¿¼ë¦¬ë“¤ (ëª¨ë‘ ìœ„ì— ì •ì˜ëœ rentalOfferResponseMap ì°¸ì¡° ðŸ’¡) -->
    <!-- ============================================== -->

    <!-- ëª¨ë“  ë§¤ë¬¼ê³¼ ê·¸ì— ì—°ê²°ëœ ì´ë¯¸ì§€ ë¦¬ìŠ¤íŠ¸ë¥¼ ì¡°íšŒí•˜ëŠ” ì¿¼ë¦¬ (í™ˆ í™”ë©´) -->

<!--    <select id="findAllRentalOffersWithImages"-->
<!--            resultMap="rentalOfferResponseMap"> &lt;!&ndash; ìœ„ì— ì •ì˜ëœ resultMapì˜ idë§Œ ì°¸ì¡°! &ndash;&gt;-->
<!--        SELECT-->
<!--        ro.idx AS ro_idx,-->
<!--        ro.account_id,-->
<!--        ro.car_idx,-->
<!--        ro.rental_price,-->
<!--        ro.description,-->
<!--        ci.idx AS ci_idx,-->
<!--        ci.rental_offer_idx AS ci_rental_offer_idx,-->
<!--        ci.img AS img_url-->
<!--        FROM-->
<!--        rental_offer ro-->
<!--        LEFT JOIN-->
<!--        car_img ci ON ro.idx = ci.rental_offer_idx-->
<!--        ORDER BY-->
<!--        ro.idx DESC, ci.idx ASC-->
<!--    </select>-->

    <!-- ë§¤ë¬¼ ì „ì²´ ì¡°íšŒ -->
    <select id="findAllRentalOffersWithImages" resultType="RentalOfferAddReviewResponse">
        select account. nickname , rental_offer.rental_price, rental_offer.description,
        car.* from rental_offer
        left join account on rental_offer.account_id = account. id
        left join car on rental_offer.car_idx = car.idx
    </select>
    <!-- ë§¤ë¬¼ ì „ì²´ ì´ë¯¸ì§€ -->
    <select id="rentalOfferAllImages" resultType="CarImg">
        select
        rental_offer_idx,
        img
        from car_img
        where rental_offer_idx in
        <foreach collection="ids"
                 item="id"
                 open="("
                 separator=","
                 close=")">
            #{id}
        </foreach>
    </select>

    <!-- íŠ¹ì • ë‚ ì§œì— ì‚¬ìš© ê°€ëŠ¥í•œ ë§¤ë¬¼ê³¼ ê·¸ì— ì—°ê²°ëœ ì´ë¯¸ì§€ ë¦¬ìŠ¤íŠ¸ ì¡°íšŒ (ë‚ ì§œ í•„í„°ë§ í™”ë©´) -->
    <!-- resultMapì„ ì‚¬ìš©í•´ì„œ ë°˜í™˜ íƒ€ìž…ì„ RentalOfferResponseë¡œ ë³€ê²½! -->
    <select id="findAvailableRentalOffers"
            resultMap="rentalOfferResponseMap"> <!-- ìœ„ì— ì •ì˜ëœ resultMapì˜ idë§Œ ì°¸ì¡°! -->
        SELECT
        ro.idx AS ro_idx,
        ro.account_id, <!-- ro.member_id ëŒ€ì‹  ro.account_id (ì´ì „ í”¼ë“œë°±ì—ì„œ ìˆ˜ì •) -->
        ro.car_idx,
        ro.rental_price,
        ro.description,
        ci.idx AS ci_idx,
        ci.rental_offer_idx AS ci_rental_offer_idx,
        ci.img AS img_url
        FROM
        rental_offer ro
        LEFT JOIN
        car_img ci ON ro.idx = ci.rental_offer_idx
        WHERE
        NOT EXISTS (
        SELECT 1
        FROM reservation res
        WHERE
        res.rental_offer_idx = ro.idx
        AND res.reservation_status = TRUE <!-- is_reserved = 1 ëŒ€ì‹  reservation_status = TRUE (ì´ì „ í”¼ë“œë°±ì—ì„œ ìˆ˜ì •) -->
        AND (
        (res.start_date &lt; #{desiredEndDate}) AND (res.end_date &gt; #{desiredStartDate})
        )
        )
        ORDER BY
        ro.idx DESC, ci.idx ASC
    </select>

    <!-- íŠ¹ì • ë§¤ë¬¼ ì •ë³´ -->
    <select id="selectRentalOfferAndReview" resultType="RentalOfferAddReviewResponse">
        select account.nickname, rental_offer.idx, rental_offer.rental_price, rental_offer.description, car.*
        from rental_offer
        join account on account.id = rental_offer.account_id
        join car on rental_offer.car_idx = car.idx
        where rental_offer.idx = #{rentalOfferIdx};
    </select>
</mapper>